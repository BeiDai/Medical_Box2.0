## 工作日志

- 2017.12.23

  调试ESP8266WIFI串口通讯使用，并增加了ESP8266的使用经验。这次主要是对串口的使用，下一步工作是通过手机发送命令，控制药盒转到相应位置，估计要用到中断。

- 2017.12.24

  设置手机发送的数据的后两位为指令，设置position0，1暂时用到position0，1-8表示药盒的位置。把变量设置为全局变量，通过头文件的extern定义来使其他函数能够调用。在调试过程中遇到了两个问题，放入TIM中断服务函数中时，令接收标志位为零时程序卡死在usart3发送指令给ESP8266中。在把接收数据置给position放在USART3_IRQHandler()串口中断函数中，第一次发送的数据第二次才可以接收到。这次主要完成了OLED显示汉字，手机发送1-8，stm32识别后显示在OLED上。通过选择语句控制药盒转动。

  修改了.ignore的内容，忽略调试编译产生的文件变化，直接忽略MDK-ARM下的文件。

- 2017.12.25

  成功实现了手机发送1-8，控制药盒转到1-8的对应位置；实现想法：开始时初始化药盒位置，通过干簧管确定1号药盒的具体位置，接收手机的指令，通过指令与实际药盒位置的差值来控制步进电机使药盒转到指令位置。通过软件调试发现找出问题在哪里更准确简单。

- 2018.3.5

  加入了uCOSIII系统，初步调试系统可行，但未整合到原来裸跑的系统中

- 2018.3.9

  UCOS系统整合到裸跑系统中，出现几个问题：
  - wifi初始化函数作为任务，并加入 **中断保护**；结果无法中断进入WiFi初始化函数；
  - **硬件调试** 加入系统后，调试会卡再OSStart()函数，无法正常调试；
  - **任务建立不是一个死循环**，从低级任务切换到高级任务时，高级任务没有执行；
  - **延时函数** 需要系统中断，不可放入代码保护区；

  任务设计流程为：
  - ----> main()主函数： 初始化参数，初始化wifi参数，创建开始任务(10)
  - ----> 开始任务： 创建wifi任务，位置初始化任务，主任务
  - ----> LED闪烁    任务挂起
  - ----> 位置初始化  任务挂起
  - ----> 主任务，接收WiFi数据，延时，任务调度，进入LED闪烁任务

  后期可以加入，**时钟功能，温湿度功能；**

### 2018.4.4

** PCB板原理图设计及测试问题 **

     PCB板问题：
    - 电容焊接反了，接上电后电容炸了
    - 芯片参考电压没有接0R电阻VREF+ 与 VDDA没有接在一起

    下载程序问题：
    - 芯片出产时锁死，需要设置，使用STM32 ST-LINK Utility软件消除出厂保护
    - Keil设置，C/C++设置optimize模式设置，leve(0-4)读写权限设置
    - Boot引脚没有接，Boot0与Boot1没有都设置为0，没有从flash启动，芯片没有工作

### 2018.4.22

** 手机APP修改STM32时间问题 **

    - STM32接收到的数据不完全是手机发送数据
    // 定义用户数据起始位置
    // < ><
    // ><+><I><P><D><,><0><,><num><:>   <Start_Number>..... <\0>   num = rlen - 12;
    // 如果num为个数：a[11]开始 Start_Number = 11;
    // Start_Number = Start_Number + (num的位数)

    - 位置修改数据格式 0+位置
    - 时间接收数据格式 6#0018-04-21#18:00:00#7

### 2018.7.21

** DHT11 温湿度传感器使用 **

    DHT11 的技术参数如下：
      工作电压范围：3.3V-5.5V
      工作电流 ：平均 0.5mA
      输出：单总线数字信号
      测量范围：湿度 20~90％RH，温度 0~50℃
      精度 ：湿度±5%，温度±2℃
      分辨率 ：湿度 1%，温度 1℃

    正面从左到右引脚分别为：

    VCC   Dout    NC    GND   （电源接反了DH11会发烫，融化塑料外壳）

    DHT11 数字湿温度传感器采用单总线数据格式。即，单个数据引脚端口完成输入输出双向
    传输。其数据包由 5Byte（40Bit）组成。数据分小数部分和整数部分，一次完整的数据
    传输为0bit，高位先出。
    **DHT11 的数据格式为：8bit 湿度整数数据  +  8bit 湿度小数数据  +
    8bit温度整数数据  +  8bit 温度小数数据  +  8bit 校验和
    其中校验和数据为前四个字节相加**

    例如：
          byte4      byte3      byte2      byte1      byte0
        00101101 + 00000000 + 00011100 + 00000000 + 01001001
          整数        小数       整数       小数      校验和
                湿度                  温度

    传感器数据输出的是未编码的二进制数据。

    湿度= byte4 . byte3=45.0 (％RH)
    温度= byte2 . byte1=28.0 ( ℃)
    校验= byte4+ byte3+ byte2+ byte1=73(=湿度+温度)(校验正确)

    DHT11和MCU的一次通信最大为3ms左右，建议主机连续读取时间间隔不要小于 100ms

    DHT11 的数据发送流程：

    首先主机发送开始信号，即：拉低数据线，保持 t1（至少 18ms）时间
    然后拉高数据线 t2（20~40us）时间，然后读取 DHT11 的响应
    正常的话，DHT11 会拉低数据线，保持 t3（40~50us）时间
    作为响应信号，然后 DHT11 拉高数据线，保持 t4（40~50us）时间后，开始输出数据。

    0： 12-14us低电平  --  26-28us高电平
    1： 12-14us低电平  --  116-118us高电平



### 2018.7.22

** esp8266接收与解析客户端数据 **

    - ESP8266接收到的数据不是客户端发送的，还有一些其它格式
    - 需要解析数据获取客户端发送的数据
    - 定义字符串返回与字符串输入参数的函数
          u8* ReceiveMessage(u8 *str)
    -     通过‘ ’空字符获取总长度，通过‘:’字符定位数据起点等

        //    对ESP8266接收的数据进行解码
        //    
        //    ESP8266作为接收客户端发送的数据：

        //    0,CONNECT

        //    +IPD,0,7:1230222   0,CLOSED     

        //    +IPD，客户端号，接收到的7位数据 + 结束符0   

        //    USART3_RX_BUF[rlen]=0;  0即是空字符
